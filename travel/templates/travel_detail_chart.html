{% extends 'travel_detail_full.html' %}
{% load static %}

{% block styles %}
    {{ block.super }}
    <link rel="stylesheet" type="text/css" href="{% static 'travel/style.css' %}">
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/> 
{% endblock %}

{% block travel_detail_content %}
       {{ block.super }}
<div class="content-travel-full">       
  <div class="content-container">
    <div class="map-container_2">
      <div id="map_1"></div> <!-- Установите высоту контейнера карты -->
      <div id="menu-container">
        <button id="start-animation">Старт</button>
        <div id='start-animation-speed'>
          <select id='style-selector-speed'>        
            <option value="150">x1</option>
            <option value="50">x2</option>
            <option value="20">x3</option>
            <option value="10">x4</option>
            <option value="1">x5</option>
            <option value="0.1">x6</option>
            <option value="0.01">x7</option>
            <option value="0.001">x8</option>          
          </select>
        </div>
        <div id='style-menu'>
          <select id='style-selector'>        
            <option value='mapbox://styles/jonengineer/clp1i7gue01c001qyaew4btuj'>Природа</option>
            <option value='mapbox://styles/mapbox/streets-v11'>Улицы</option>
            <option value='mapbox://styles/mapbox/light-v10'>Светлый</option>
            <option value='mapbox://styles/mapbox/dark-v10'>Тёмный</option>
            <option value='mapbox://styles/mapbox/satellite-v9'>Спутник</option>        
          </select>
        </div>
      </div>         
    </div>
    <div id="charts-container">
      <div id="elevation_chart_div"></div>
    </div>
  </div>
  <div class="content-collapsible">
    <ul class="collapsible">
      <li id="li">
        <div class="collapsible-header">
          <img class="point-icons" src="/static/travel/img/point.svg">Добавить точку                  
        </div>
        <div class="collapsible-body">
          <!-- Форма для добавления новой точки -->
          <form id="addPointForm" method="post" action="{% url 'travel:add_point_trek' travel.travelplan_id %}">
            {% csrf_token %}
            <div class="collapsible-input_text">
              <input id="input_text" type="text" class="input-point" name="namepoint" placeholder="Укажите название точки" data-length="35">
            </div>
            <input type="text" class="input-point" name="point_сoordinates" placeholder="Укажите координаты на карте" maxlength="25" readonly> 
            <textarea  id="textarea2" class="materialize-textarea" name="description" placeholder="Описание точки" data-length="400"></textarea>                         
            <button id="submitButton">Добавить</button>
          </form>
        </div>
      </li>          
    </ul>
    <!-- Второй контейнер для отображения существующих точек -->
    <ul class="collapsible">
      {% for point in travel_points %}
          <li id="li">
              <div class="collapsible-header">
                  <img class="point-icons" src="/static/travel/img/point.svg">
                  <div class="collapsible-header-text">
                    {{ point.namepoint }}
                  </div>
                  <div class="collapsible-header-delete-button">
                    <form method="POST" action="{% url 'travel:delete_travel_point' point_trek_id=point.point_trek_id %}">
                      {% csrf_token %}
                      <button type="submit" class="delete-button-point">                
                        <img id="delete-button-icons-point" src="/static/travel/img/delete.svg">
                        <span class="tooltip-text">Удалить точку</span>
                      </button>
                    </form>
                  </div>
              </div>
              <div class="collapsible-body">
                <span> {{ point.description }} </span>
              </div>
          </li>
      {% empty %}
          <li>
              <div class="collapsible-header">Нет сохраненных точек</div>
          </li>
      {% endfor %}
    </ul>
  </div>   
</div>   
{% endblock %}

{% block travel_detail_scripts %}
    {{ block.super }}
<link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet">
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0"></script>
<!-- Графики-->
<script>
  // Предположим, что переменная gpxData была инициализирована с данными из вашего GPX файла.
  var gpxData = JSON.parse('{{ gpx_data|safe }}');

  google.charts.load('current', {'packages':['corechart']});
  google.charts.setOnLoadCallback(drawElevationDistanceChart);  

  var elevationChart, heartRateChart;
  var elevationData, heartRateData;
  var elevationOptions, heartRateOptions;

  function drawElevationDistanceChart() {
    elevationData = new google.visualization.DataTable();
    elevationData.addColumn('number', 'Расстояние');
    elevationData.addColumn('number', 'Высота');

    for (var i = 0; i < gpxData.distances.length; i++) {
      elevationData.addRow([gpxData.distances[i], gpxData.elevation_points[i]]);
    }

    elevationOptions = {
      width: '100%',
      height: '100%',
      title: 'Профиль высот',
      curveType: 'function',
      legend: { position: 'none' },            
      colors: ['#676418'],
      hAxis: { title: 'S, км' },
      vAxis: { title: 'H, м' },
      backgroundColor: '#9CABAE',
      colors: ['#676418'],
      areaOpacity: 0.6, // Пример прозрачности заливки (от 0.0 до 1.0)
      chartArea: {
        backgroundColor: {
          stroke: '#3C2C13',
          strokeWidth: 1
        },
        left: 70,
        top: 20,
        width: '85%',
        height: '60%'
      }
    };
    // Настройки оси Y (vAxis)
    elevationOptions.vAxis = elevationOptions.vAxis || {}; // Создаем объект vAxis, если он еще не создан
    elevationOptions.vAxis.viewWindow = elevationOptions.vAxis.viewWindow || {}; // То же самое для viewWindow

    // Устанавливаем максимальное значение
    var maxElevation = Math.max.apply(null, gpxData.elevation_points);
    elevationOptions.vAxis.viewWindow.max = maxElevation + (maxElevation * 0.01); // Добавляем 3% отступа

    // Устанавливаем минимальное значение, если нужно
    var minElevation = Math.min.apply(null, gpxData.elevation_points);
    elevationOptions.vAxis.viewWindow.min = minElevation - (minElevation * 0.01); // Добавляем 3% отступа, если есть отрицательные значения


    elevationChart = new google.visualization.AreaChart(document.getElementById('elevation_chart_div'));
    elevationChart.draw(elevationData, elevationOptions);
  }
  
  window.addEventListener('resize', function() {
    if (elevationChart) {
      elevationChart.draw(elevationData, elevationOptions);
    }
  }, { passive: true });

</script>
<!-- Карта-->
<script>
  let animatedMarker; // Объявление в глобальной области видимости
  document.addEventListener('DOMContentLoaded', (event) => {
    mapboxgl.accessToken = 'pk.eyJ1Ijoiam9uZW5naW5lZXIiLCJhIjoiY2xvcm1jeGZxMHc4eDJxcDVsZnZpZzI4ayJ9.Ou-RGij5NC3X3LpByDstZQ';
  
    let map_1;
    let firstPointCoordinates, lastPointCoordinates, centerCoordinates;
    travelGeoJSON = {{ gpx_data_track|safe }};
  
    if (travelGeoJSON && travelGeoJSON.features && travelGeoJSON.features.length > 0) {
      firstPointCoordinates = travelGeoJSON.features[0].geometry.coordinates[0];
      lastPointCoordinates = travelGeoJSON.features[0].geometry.coordinates[travelGeoJSON.features[0].geometry.coordinates.length - 1];
      centerCoordinates = firstPointCoordinates.slice(0, 2);
  
      map_1 = new mapboxgl.Map({
        container: 'map_1',
        center: centerCoordinates,
        zoom: 13,
        projection: 'mercator',
        style: 'mapbox://styles/jonengineer/clp1i7gue01c001qyaew4btuj',
        // ... другие параметры карты
      });
  
      var selector = document.getElementById('style-selector');
      selector.addEventListener('change', function() {
        map_1.setStyle(this.value);
      });

    // Предполагается, что 'map' - это ваша карта Mapbox
    map_1.on('click', function(e) {
      // Получаем координаты из события клика
      var coords = e.lngLat;

      // Форматируем координаты для отображения (например, до 4 знаков после запятой)
      var formattedCoords = coords.lat.toFixed(4) + ", " + coords.lng.toFixed(4);

      // Устанавливаем координаты в поле формы
      document.getElementsByName('point_сoordinates')[0].value = formattedCoords;
    });  
  
    map_1.on('style.load', function() {
      if (!map_1.getSource('route')) {
        map_1.addSource('route', {
          type: 'geojson',
          data: {{ gpx_data_track|safe }}
        });
      }
  
      if (!map_1.getLayer('route')) {
        map_1.addLayer({
          id: 'route',
          type: 'line',
          source: 'route',
          layout: {
            'line-join': 'round',
            'line-cap': 'round'
          },
          paint: {
            'line-color': '#D32F2F',
            'line-width': 6
          }
        });
      }  
         
      new mapboxgl.Marker({
        element: createStaticMarkerElement('/static/travel/img/start-icon.svg', 25, 25)
      })
      .setLngLat(firstPointCoordinates)
      .addTo(map_1);

      new mapboxgl.Marker({
        element: createStaticMarkerElement('/static/travel/img/end-icon.svg', 25, 25)
      })
      .setLngLat(lastPointCoordinates)
      .addTo(map_1);
    });

      // Убедитесь, что firstPointCoordinates определены
    if (firstPointCoordinates) {
      // Создание маркера для анимации
      var travelType = {{ travel.traveltype_id }};
      const markerElement = createCustomMarkerElement(travelType, 35, 35);
      animatedMarker = new mapboxgl.Marker({
        element: markerElement
      }).setLngLat(firstPointCoordinates); // Инициализация с начальными координатами
    }

    let animationSpeed = 100; // Объявите animationSpeed в глобальной области видимости
    
    document.getElementById('style-selector-speed').addEventListener('change', function() {
      animationSpeed = parseFloat(this.value)
    });
    // Функция для создания анимации
    let counter = 0;    
    function animateTravel() {
      const coordinates_animate = travelGeoJSON.features[0].geometry.coordinates;
      if (counter < coordinates_animate.length) {
        // Анимация маркера
        animatedMarker.setLngLat(coordinates_animate[counter]);
    
        // Создание геометрии трека на основе пройденного пути
        if (counter > 0) { // Изменение условия
          const path = coordinates_animate.slice(0, counter + 1);
          if (path.length >= 2) { // Добавление проверки на количество координат
            lineString = turf.lineString(path);
            map_1.getSource('route').setData(lineString);
          }
        }
        counter++;
        setTimeout(() => requestAnimationFrame(animateTravel), animationSpeed);
      }
    }    
    // Подключение функции анимации к кнопке
    document.getElementById('start-animation').addEventListener('click', () => {
      counter = 0; // Сброс счетчика для повторного запуска
      // Установка начального положения маркера и добавление его на карту
      animatedMarker.setLngLat(firstPointCoordinates).addTo(map_1);
      animateTravel(); // Используйте animateTravel
    });

    var pointGeoJSON = {{ gpx_data_point|safe }};    
    // Добавление иконок точек на карту
    if (pointGeoJSON) {
      Object.values(pointGeoJSON).forEach(function(point) {
          // Создание иконки
          var marker = new mapboxgl.Marker({
              element: createStaticMarkerElement('/static/travel/img/location_point.svg', 35, 35) // Путь к вашей иконке
          })
              .setLngLat(point.geometry.coordinates) // Установка координат точки
              .addTo(map_1);
  
          // Добавление всплывающего окна с именем точки при наведении
          var popup = new mapboxgl.Popup({
              offset: 25
          })
              .setHTML('<h3>' + point.properties.name + '</h3>');
  
          marker.setPopup(popup);
      });
    } else {
      console.error('Ошибка: Нет данных о точках в GeoJSON.');
    }
  }
  });  
  function createCustomMarkerElement(travelType, width, height, rotationAngle) {
    var iconUrl;
    // Определение URL иконки на основе типа путешествия
    switch (travelType) {
      case 1: 
        iconUrl = '/static/travel/img/hiking_treking.svg';
        break;
      case 2: 
        iconUrl = '/static/travel/img/hiking_mountains.svg';
        break;
      case 3: 
        iconUrl = '/static/travel/img/bicycle.svg';
        break;
      case 4: 
        iconUrl = '/static/travel/img/skiing_man.svg';
        break;  
      case 5: 
        iconUrl = '/static/travel/img/river_rafting.svg'; 
        break;
      case 6: 
        iconUrl = '/static/travel/img/motorcycle_traveller.svg';
        break;  
      case 7: 
        iconUrl = '/static/travel/img/car.svg'; 
        break;
      // Добавьте дополнительные случаи для других типов путешествий
      default:
      iconUrl = '/static/travel/img/car.svg'; // URL иконки по умолчанию
    }
        
    var el = document.createElement('div');
    el.style.backgroundImage = `url(${iconUrl})`;
    el.style.width = width + 'px';
    el.style.height = height + 'px';
    el.style.backgroundSize = 'contain'; // Используйте 'contain' для сохранения пропорций
    return el;
  }
  function createStaticMarkerElement(iconUrl, width, height) {
    var el = document.createElement('div');
    el.style.backgroundImage = `url(${iconUrl})`;
    el.style.width = width + 'px';
    el.style.height = height + 'px';
    el.style.backgroundSize = 'contain'; // Используйте 'contain' для сохранения пропорций
    return el;
  }
</script>
<!-- Выпадающий список-->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    var elems = document.querySelectorAll('select');
    var instances = M.FormSelect.init(elems, {});
  });
</script>
<!-- точки -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    var elems = document.querySelectorAll('.collapsible');
    var instances = M.Collapsible.init(elems);
  });
</script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    var textNeedCount = document.querySelectorAll('#input_text, #textarea2');
    M.CharacterCounter.init(textNeedCount);
  });
</script>
{% endblock %}